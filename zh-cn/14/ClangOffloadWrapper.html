<!DOCTYPE html>

<html lang="zh-CN" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Clang Offload Wrapper &#8212; Clang  文档</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="_static/haiku.css?v=fce32b03" />
    <script src="_static/documentation_options.js?v=7d86a446"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/translations.js?v=beaddf03"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/clang-docs-l10n/ClangOffloadWrapper.html" />
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="&#34;Clang&#34; CFE Internals Manual" href="InternalsManual.html" />
    <link rel="prev" title="Clang Offload Bundler" href="ClangOffloadBundler.html" />
<script type="text/javascript" src="ltd-provenance.js"></script>
<script type="text/javascript" src="ltd-current.js"></script>
<script type="text/javascript" src="../../ltd-config.js"></script>
<script type="text/javascript" src="../../ltd-flyout.js"></script>

  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Clang  文档</span></a></h1>
        <h2 class="heading"><span>Clang Offload Wrapper</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="Top">
      
        <p>
        «&#160;&#160;<a href="ClangOffloadBundler.html">Clang Offload Bundler</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">目录</a>
        &#160;&#160;::&#160;&#160;
        <a href="InternalsManual.html">&quot;Clang&quot; CFE Internals Manual</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="clang-offload-wrapper">
<h1>Clang Offload Wrapper<a class="headerlink" href="#clang-offload-wrapper" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="id1">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id4">Introduction</a></p></li>
<li><p><a class="reference internal" href="#usage" id="id5">Usage</a></p></li>
<li><p><a class="reference internal" href="#example" id="id6">Example</a></p></li>
<li><p><a class="reference internal" href="#openmp-device-binary-embedding" id="id7">OpenMP Device Binary Embedding</a></p>
<ul>
<li><p><a class="reference internal" href="#enum-types" id="id8">Enum Types</a></p></li>
<li><p><a class="reference internal" href="#structure-types" id="id9">Structure Types</a></p></li>
<li><p><a class="reference internal" href="#global-variables" id="id10">Global Variables</a></p>
<ul>
<li><p><a class="reference internal" href="#binary-descriptor-for-device-images" id="id11">Binary Descriptor for Device Images</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#global-constructor-and-destructor" id="id12">Global Constructor and Destructor</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#image-binary-embedding-and-execution-for-openmp" id="id13">Image Binary Embedding and Execution for OpenMP</a></p></li>
</ul>
</nav>
<section id="introduction">
<span id="id2"></span><h2><a class="toc-backref" href="#id4" role="doc-backlink">Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>This tool is used in OpenMP offloading toolchain to embed device code objects
(usually ELF) into a wrapper host llvm IR (bitcode) file. The wrapper host IR
is then assembled and linked with host code objects to generate the executable
binary. See <a class="reference internal" href="#image-binary-embedding-execution"><span class="std std-ref">Image Binary Embedding and Execution for OpenMP</span></a> for more details.</p>
</section>
<section id="usage">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Usage</a><a class="headerlink" href="#usage" title="Link to this heading">¶</a></h2>
<p>This tool can be used as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>clang-offload-wrapper<span class="w"> </span>-help
<span class="go">OVERVIEW: A tool to create a wrapper bitcode for offload target binaries.</span>
<span class="go">Takes offload target binaries as input and produces bitcode file containing</span>
<span class="go">target binaries packaged as data and initialization code which registers</span>
<span class="go">target binaries in offload runtime.</span>
<span class="go">USAGE: clang-offload-wrapper [options] &lt;input files&gt;</span>
<span class="go">OPTIONS:</span>
<span class="go">Generic Options:</span>
<span class="go">  --help                             - Display available options (--help-hidden for more)</span>
<span class="go">  --help-list                        - Display list of available options (--help-list-hidden for more)</span>
<span class="go">  --version                          - Display the version of this program</span>
<span class="go">clang-offload-wrapper options:</span>
<span class="go">  -o=&lt;filename&gt;                      - Output filename</span>
<span class="go">  --target=&lt;triple&gt;                  - Target triple for the output module</span>
</pre></div>
</div>
</section>
<section id="example">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Example</a><a class="headerlink" href="#example" title="Link to this heading">¶</a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">clang-offload-wrapper -target host-triple -o host-wrapper.bc gfx90a-binary.out</span>
</pre></div>
</div>
</section>
<section id="openmp-device-binary-embedding">
<span id="id3"></span><h2><a class="toc-backref" href="#id7" role="doc-backlink">OpenMP Device Binary Embedding</a><a class="headerlink" href="#openmp-device-binary-embedding" title="Link to this heading">¶</a></h2>
<p>Various structures and functions used in the wrapper host IR form the interface
between the executable binary and the OpenMP runtime.</p>
<section id="enum-types">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Enum Types</a><a class="headerlink" href="#enum-types" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="#table-offloading-declare-target-flags"><span class="std std-ref">Offloading Declare Target Flags Enum</span></a> lists different flag for
offloading entries.</p>
<blockquote>
<div><table class="docutils align-default" id="table-offloading-declare-target-flags">
<caption><span class="caption-text">Offloading Declare Target Flags Enum</span><a class="headerlink" href="#table-offloading-declare-target-flags" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>OMP_DECLARE_TARGET_LINK</p></td>
<td><p>0x01</p></td>
<td><p>Mark the entry as having a 'link' attribute (w.r.t. link clause)</p></td>
</tr>
<tr class="row-odd"><td><p>OMP_DECLARE_TARGET_CTOR</p></td>
<td><p>0x02</p></td>
<td><p>Mark the entry as being a global constructor</p></td>
</tr>
<tr class="row-even"><td><p>OMP_DECLARE_TARGET_DTOR</p></td>
<td><p>0x04</p></td>
<td><p>Mark the entry as being a global destructor</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="structure-types">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Structure Types</a><a class="headerlink" href="#structure-types" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="#table-tgt-offload-entry"><span class="std std-ref">__tgt_offload_entry structure</span></a>, <a class="reference internal" href="#table-tgt-device-image"><span class="std std-ref">__tgt_device_image structure</span></a>, and
<a class="reference internal" href="#table-tgt-bin-desc"><span class="std std-ref">__tgt_bin_desc structure</span></a> are the structures used in the wrapper host IR.</p>
<blockquote>
<div><table class="docutils align-default" id="table-tgt-offload-entry">
<caption><span class="caption-text">__tgt_offload_entry structure</span><a class="headerlink" href="#table-tgt-offload-entry" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Identifier</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>void*</p></td>
<td><p>addr</p></td>
<td><p>Address of global symbol within device image (function or global)</p></td>
</tr>
<tr class="row-odd"><td><p>char*</p></td>
<td><p>name</p></td>
<td><p>Name of the symbol</p></td>
</tr>
<tr class="row-even"><td><p>size_t</p></td>
<td><p>size</p></td>
<td><p>Size of the entry info (0 if it is a function)</p></td>
</tr>
<tr class="row-odd"><td><p>int32_t</p></td>
<td><p>flags</p></td>
<td><p>Flags associated with the entry (see <a class="reference internal" href="#table-offloading-declare-target-flags"><span class="std std-ref">Offloading Declare Target Flags Enum</span></a>)</p></td>
</tr>
<tr class="row-even"><td><p>int32_t</p></td>
<td><p>reserved</p></td>
<td><p>Reserved, to be used by the runtime library.</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="table-tgt-device-image">
<caption><span class="caption-text">__tgt_device_image structure</span><a class="headerlink" href="#table-tgt-device-image" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Identifier</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>void*</p></td>
<td><p>ImageStart</p></td>
<td><p>Pointer to the target code start</p></td>
</tr>
<tr class="row-odd"><td><p>void*</p></td>
<td><p>ImageEnd</p></td>
<td><p>Pointer to the target code end</p></td>
</tr>
<tr class="row-even"><td><p>__tgt_offload_entry*</p></td>
<td><p>EntriesBegin</p></td>
<td><p>Begin of table with all target entries</p></td>
</tr>
<tr class="row-odd"><td><p>__tgt_offload_entry*</p></td>
<td><p>EntriesEnd</p></td>
<td><p>End of table (non inclusive)</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="table-tgt-bin-desc">
<caption><span class="caption-text">__tgt_bin_desc structure</span><a class="headerlink" href="#table-tgt-bin-desc" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Identifier</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>int32_t</p></td>
<td><p>NumDeviceImages</p></td>
<td><p>Number of device types supported</p></td>
</tr>
<tr class="row-odd"><td><p>__tgt_device_image*</p></td>
<td><p>DeviceImages</p></td>
<td><p>Array of device images (1 per dev. type)</p></td>
</tr>
<tr class="row-even"><td><p>__tgt_offload_entry*</p></td>
<td><p>HostEntriesBegin</p></td>
<td><p>Begin of table with all host entries</p></td>
</tr>
<tr class="row-odd"><td><p>__tgt_offload_entry*</p></td>
<td><p>HostEntriesEnd</p></td>
<td><p>End of table (non inclusive)</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="global-variables">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Global Variables</a><a class="headerlink" href="#global-variables" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="#table-global-variables"><span class="std std-ref">Global Variables</span></a> lists various global variables, along with their
type and their explicit ELF sections, which are used to store device images and
related symbols.</p>
<blockquote>
<div><table class="docutils align-default" id="table-global-variables">
<caption><span class="caption-text">Global Variables</span><a class="headerlink" href="#table-global-variables" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>ELF Section</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>__start_omp_offloading_entries</p></td>
<td><p>__tgt_offload_entry</p></td>
<td><p>.omp_offloading_entries</p></td>
<td><p>Begin symbol for the offload entries table.</p></td>
</tr>
<tr class="row-odd"><td><p>__stop_omp_offloading_entries</p></td>
<td><p>__tgt_offload_entry</p></td>
<td><p>.omp_offloading_entries</p></td>
<td><p>End symbol for the offload entries table.</p></td>
</tr>
<tr class="row-even"><td><p>__dummy.omp_offloading.entry</p></td>
<td><p>__tgt_offload_entry</p></td>
<td><p>.omp_offloading_entries</p></td>
<td><p>Dummy zero-sized object in the offload entries
section to force linker to define begin/end
symbols defined above.</p></td>
</tr>
<tr class="row-odd"><td><p>.omp_offloading.device_image</p></td>
<td><p>__tgt_device_image</p></td>
<td><p>.omp_offloading_entries</p></td>
<td><p>ELF device code object of the first image.</p></td>
</tr>
<tr class="row-even"><td><p>.omp_offloading.device_image.N</p></td>
<td><p>__tgt_device_image</p></td>
<td><p>.omp_offloading_entries</p></td>
<td><p>ELF device code object of the (N+1)th image.</p></td>
</tr>
<tr class="row-odd"><td><p>.omp_offloading.device_images</p></td>
<td><p>__tgt_device_image</p></td>
<td><p>.omp_offloading_entries</p></td>
<td><p>Array of images.</p></td>
</tr>
<tr class="row-even"><td><p>.omp_offloading.descriptor</p></td>
<td><p>__tgt_bin_desc</p></td>
<td><p>.omp_offloading_entries</p></td>
<td><p>Binary descriptor object (see details below).</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<section id="binary-descriptor-for-device-images">
<h4><a class="toc-backref" href="#id11" role="doc-backlink">Binary Descriptor for Device Images</a><a class="headerlink" href="#binary-descriptor-for-device-images" title="Link to this heading">¶</a></h4>
<p>This object is passed to the offloading runtime at program startup and it
describes all device images available in the executable or shared library. It
is defined as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">__attribute__((visibility(&quot;hidden&quot;)))</span>
<span class="go">extern __tgt_offload_entry *__start_omp_offloading_entries;</span>
<span class="go">__attribute__((visibility(&quot;hidden&quot;)))</span>
<span class="go">extern __tgt_offload_entry *__stop_omp_offloading_entries;</span>
<span class="go">static const char Image0[] = { &lt;Bufs.front() contents&gt; };</span>
<span class="go">...</span>
<span class="go">static const char ImageN[] = { &lt;Bufs.back() contents&gt; };</span>
<span class="go">static const __tgt_device_image Images[] = {</span>
<span class="go">  {</span>
<span class="go">    Image0,                            /*ImageStart*/</span>
<span class="go">    Image0 + sizeof(Image0),           /*ImageEnd*/</span>
<span class="go">    __start_omp_offloading_entries,    /*EntriesBegin*/</span>
<span class="go">    __stop_omp_offloading_entries      /*EntriesEnd*/</span>
<span class="go">  },</span>
<span class="go">  ...</span>
<span class="go">  {</span>
<span class="go">    ImageN,                            /*ImageStart*/</span>
<span class="go">    ImageN + sizeof(ImageN),           /*ImageEnd*/</span>
<span class="go">    __start_omp_offloading_entries,    /*EntriesBegin*/</span>
<span class="go">    __stop_omp_offloading_entries      /*EntriesEnd*/</span>
<span class="go">  }</span>
<span class="go">};</span>
<span class="go">static const __tgt_bin_desc BinDesc = {</span>
<span class="go">  sizeof(Images) / sizeof(Images[0]),  /*NumDeviceImages*/</span>
<span class="go">  Images,                              /*DeviceImages*/</span>
<span class="go">  __start_omp_offloading_entries,      /*HostEntriesBegin*/</span>
<span class="go">  __stop_omp_offloading_entries        /*HostEntriesEnd*/</span>
<span class="go">};</span>
</pre></div>
</div>
</section>
</section>
<section id="global-constructor-and-destructor">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Global Constructor and Destructor</a><a class="headerlink" href="#global-constructor-and-destructor" title="Link to this heading">¶</a></h3>
<p>Global constructor (<code class="docutils literal notranslate"><span class="pre">.omp_offloading.descriptor_reg()</span></code>) registers the library
of images with the runtime by calling <code class="docutils literal notranslate"><span class="pre">__tgt_register_lib()</span></code> function. The
cunstructor is explicitly defined in <code class="docutils literal notranslate"><span class="pre">.text.startup</span></code> section.
Similarly, global destructor
(<code class="docutils literal notranslate"><span class="pre">.omp_offloading.descriptor_unreg()</span></code>) calls <code class="docutils literal notranslate"><span class="pre">__tgt_unregister_lib()</span></code> for
the unregistration and is also defined in <code class="docutils literal notranslate"><span class="pre">.text.startup</span></code> section.</p>
</section>
</section>
<section id="image-binary-embedding-and-execution-for-openmp">
<span id="image-binary-embedding-execution"></span><h2><a class="toc-backref" href="#id13" role="doc-backlink">Image Binary Embedding and Execution for OpenMP</a><a class="headerlink" href="#image-binary-embedding-and-execution-for-openmp" title="Link to this heading">¶</a></h2>
<p>For each offloading target, device ELF code objects are generated by <code class="docutils literal notranslate"><span class="pre">clang</span></code>,
<code class="docutils literal notranslate"><span class="pre">opt</span></code>, <code class="docutils literal notranslate"><span class="pre">llc</span></code>, and <code class="docutils literal notranslate"><span class="pre">lld</span></code> pipeline. These code objects are passed to the
<code class="docutils literal notranslate"><span class="pre">clang-offload-wrapper</span></code>.</p>
<blockquote>
<div><ul class="simple">
<li><p>At compile time, the <code class="docutils literal notranslate"><span class="pre">clang-offload-wrapper</span></code> tool takes the following
actions:</p>
<ul>
<li><p>It embeds the ELF code objects for the device into the host code (see
<a class="reference internal" href="#openmp-device-binary-embedding"><span class="std std-ref">OpenMP Device Binary Embedding</span></a>).</p></li>
</ul>
</li>
<li><p>At execution time:</p>
<ul>
<li><p>The global constructor gets run and it registers the device image.</p></li>
</ul>
</li>
</ul>
</div></blockquote>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="Bottom">
      
        <p>
        «&#160;&#160;<a href="ClangOffloadBundler.html">Clang Offload Bundler</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">目录</a>
        &#160;&#160;::&#160;&#160;
        <a href="InternalsManual.html">&quot;Clang&quot; CFE Internals Manual</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; 版权所有 2007-2025, The Clang Team.
      由 <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3创建。
    </div>
  </body>
</html>