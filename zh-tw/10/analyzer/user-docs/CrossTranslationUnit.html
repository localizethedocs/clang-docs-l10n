<!DOCTYPE html>

<html lang="zh-TW" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>2.1. Cross Translation Unit (CTU) Analysis &#8212; Clang 10 說明文件</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="../../_static/haiku.css?v=fce32b03" />
    <script src="../../_static/documentation_options.js?v=0c09651c"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=cbf116e0"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/clang-docs-l10n/analyzer/user-docs/CrossTranslationUnit.html" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜尋" href="../../search.html" />
    <link rel="next" title="3. Developer Docs" href="../developer-docs.html" />
    <link rel="prev" title="2. User Docs" href="../user-docs.html" />
<script type="text/javascript" src="../../ltd-provenance.js"></script>
<script type="text/javascript" src="../../ltd-current.js"></script>
<script type="text/javascript" src="../../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../../ltd-flyout.js"></script>

  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../index.html">
          <span>Clang 10 說明文件</span></a></h1>
        <h2 class="heading"><span>2.1. Cross Translation Unit (CTU) Analysis</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="Top">
      
        <p>
        «&#160;&#160;<a href="../user-docs.html"><span class="section-number">2. </span>User Docs</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../index.html">內容</a>
        &#160;&#160;::&#160;&#160;
        <a href="../developer-docs.html"><span class="section-number">3. </span>Developer Docs</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="cross-translation-unit-ctu-analysis">
<h1><span class="section-number">2.1. </span>Cross Translation Unit (CTU) Analysis<a class="headerlink" href="#cross-translation-unit-ctu-analysis" title="連結到這個標頭">¶</a></h1>
<p>Normally, static analysis works in the boundary of one translation unit (TU).
However, with additional steps and configuration we can enable the analysis to inline the definition of a function from another TU.</p>
<nav class="contents local" id="id1">
<ul class="simple">
<li><p><a class="reference internal" href="#manual-ctu-analysis" id="id2">Manual CTU Analysis</a></p></li>
<li><p><a class="reference internal" href="#automated-ctu-analysis-with-codechecker" id="id3">Automated CTU Analysis with CodeChecker</a></p></li>
<li><p><a class="reference internal" href="#automated-ctu-analysis-with-scan-build-py-don-t-do-it" id="id4">Automated CTU Analysis with scan-build-py (don't do it)</a></p></li>
</ul>
</nav>
<section id="manual-ctu-analysis">
<h2><a class="toc-backref" href="#id2" role="doc-backlink"><span class="section-number">2.1.1. </span>Manual CTU Analysis</a><a class="headerlink" href="#manual-ctu-analysis" title="連結到這個標頭">¶</a></h2>
<p>Let's consider these source files in our minimal example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// main.cpp</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">();</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// foo.cpp</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And a compilation database:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>
<span class="w">  </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;directory&quot;</span>:<span class="w"> </span><span class="s2">&quot;/path/to/your/project&quot;</span>,
<span class="w">    </span><span class="s2">&quot;command&quot;</span>:<span class="w"> </span><span class="s2">&quot;clang++ -c foo.cpp -o foo.o&quot;</span>,
<span class="w">    </span><span class="s2">&quot;file&quot;</span>:<span class="w"> </span><span class="s2">&quot;foo.cpp&quot;</span>
<span class="w">  </span><span class="o">}</span>,
<span class="w">  </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;directory&quot;</span>:<span class="w"> </span><span class="s2">&quot;/path/to/your/project&quot;</span>,
<span class="w">    </span><span class="s2">&quot;command&quot;</span>:<span class="w"> </span><span class="s2">&quot;clang++ -c main.cpp -o main.o&quot;</span>,
<span class="w">    </span><span class="s2">&quot;file&quot;</span>:<span class="w"> </span><span class="s2">&quot;main.cpp&quot;</span>
<span class="w">  </span><span class="o">}</span>
<span class="o">]</span>
</pre></div>
</div>
<p>We'd like to analyze <cite>main.cpp</cite> and discover the division by zero bug.
In order to be able to inline the definition of <cite>foo</cite> from <cite>foo.cpp</cite> first we have to generate the <cite>AST</cite> (or <cite>PCH</cite>) file of <cite>foo.cpp</cite>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">pwd</span><span class="w"> </span>$<span class="w"> </span>/path/to/your/project
$<span class="w"> </span>clang++<span class="w"> </span>-emit-ast<span class="w"> </span>-o<span class="w"> </span>foo.cpp.ast<span class="w"> </span>foo.cpp
$<span class="w"> </span><span class="c1"># Check that the .ast file is generated:</span>
$<span class="w"> </span>ls
compile_commands.json<span class="w">  </span>foo.cpp.ast<span class="w">  </span>foo.cpp<span class="w">  </span>main.cpp
$
</pre></div>
</div>
<p>The next step is to create a CTU index file which holds the <cite>USR</cite> name and location of external definitions in the source files:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>clang-extdef-mapping<span class="w"> </span>-p<span class="w"> </span>.<span class="w"> </span>foo.cpp
c:@F@foo#<span class="w"> </span>/path/to/your/project/foo.cpp
$<span class="w"> </span>clang-extdef-mapping<span class="w"> </span>-p<span class="w"> </span>.<span class="w"> </span>foo.cpp<span class="w"> </span>&gt;<span class="w"> </span>externalDefMap.txt
</pre></div>
</div>
<p>We have to modify <cite>externalDefMap.txt</cite> to contain the name of the <cite>.ast</cite> files instead of the source files:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;s/.cpp/.cpp.ast/g&quot;</span><span class="w"> </span>externalDefMap.txt
</pre></div>
</div>
<p>We still have to further modify the <cite>externalDefMap.txt</cite> file to contain relative paths:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;s|</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">/||g&quot;</span><span class="w"> </span>externalDefMap.txt
</pre></div>
</div>
<p>Now everything is available for the CTU analysis.
We have to feed Clang with CTU specific extra arguments:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">pwd</span>
/path/to/your/project
$<span class="w"> </span>clang++<span class="w"> </span>--analyze<span class="w"> </span>-Xclang<span class="w"> </span>-analyzer-config<span class="w"> </span>-Xclang<span class="w"> </span>experimental-enable-naive-ctu-analysis<span class="o">=</span><span class="nb">true</span><span class="w"> </span>-Xclang<span class="w"> </span>-analyzer-config<span class="w"> </span>-Xclang<span class="w"> </span>ctu-dir<span class="o">=</span>.<span class="w"> </span>-Xclang<span class="w"> </span>-analyzer-output<span class="o">=</span>plist-multi-file<span class="w"> </span>main.cpp
main.cpp:5:12:<span class="w"> </span>warning:<span class="w"> </span>Division<span class="w"> </span>by<span class="w"> </span>zero
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="m">3</span><span class="w"> </span>/<span class="w"> </span>foo<span class="o">()</span><span class="p">;</span>
<span class="w">         </span>~~^~~~~~~
<span class="m">1</span><span class="w"> </span>warning<span class="w"> </span>generated.
$<span class="w"> </span><span class="c1"># The plist file with the result is generated.</span>
$<span class="w"> </span>ls
compile_commands.json<span class="w">  </span>externalDefMap.txt<span class="w">  </span>foo.ast<span class="w">  </span>foo.cpp<span class="w">  </span>foo.cpp.ast<span class="w">  </span>main.cpp<span class="w">  </span>main.plist
$
</pre></div>
</div>
<p>This manual procedure is error-prone and not scalable, therefore to analyze real projects it is recommended to use <cite>CodeChecker</cite> or <cite>scan-build-py</cite>.</p>
</section>
<section id="automated-ctu-analysis-with-codechecker">
<h2><a class="toc-backref" href="#id3" role="doc-backlink"><span class="section-number">2.1.2. </span>Automated CTU Analysis with CodeChecker</a><a class="headerlink" href="#automated-ctu-analysis-with-codechecker" title="連結到這個標頭">¶</a></h2>
<p>The <a class="reference external" href="https://github.com/Ericsson/codechecker">CodeChecker</a> project fully supports automated CTU analysis with Clang.
Once we have set up the <cite>PATH</cite> environment variable and we activated the python <cite>venv</cite> then it is all it takes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>CodeChecker<span class="w"> </span>analyze<span class="w"> </span>--ctu<span class="w"> </span>compile_commands.json<span class="w"> </span>-o<span class="w"> </span>reports
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span>Pre-analysis<span class="w"> </span>started.
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span>Collecting<span class="w"> </span>data<span class="w"> </span><span class="k">for</span><span class="w"> </span>ctu<span class="w"> </span>analysis.
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">1</span>/2<span class="o">]</span><span class="w"> </span>foo.cpp
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">2</span>/2<span class="o">]</span><span class="w"> </span>main.cpp
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span>Pre-analysis<span class="w"> </span>finished.
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span>Starting<span class="w"> </span>static<span class="w"> </span>analysis<span class="w"> </span>...
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">1</span>/2<span class="o">]</span><span class="w"> </span>clangsa<span class="w"> </span>analyzed<span class="w"> </span>foo.cpp<span class="w"> </span>successfully.
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">2</span>/2<span class="o">]</span><span class="w"> </span>clangsa<span class="w"> </span>analyzed<span class="w"> </span>main.cpp<span class="w"> </span>successfully.
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span>----<span class="o">====</span><span class="w"> </span><span class="nv">Summary</span><span class="w"> </span><span class="o">====</span>----
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span>Successfully<span class="w"> </span>analyzed
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w">   </span>clangsa:<span class="w"> </span><span class="m">2</span>
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span>Total<span class="w"> </span>analyzed<span class="w"> </span>compilation<span class="w"> </span>commands:<span class="w"> </span><span class="m">2</span>
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span>----<span class="o">=================</span>----
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span>Analysis<span class="w"> </span>finished.
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span>To<span class="w"> </span>view<span class="w"> </span>results<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>terminal<span class="w"> </span>use<span class="w"> </span>the<span class="w"> </span><span class="s2">&quot;CodeChecker parse&quot;</span><span class="w"> </span>command.
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span>To<span class="w"> </span>store<span class="w"> </span>results<span class="w"> </span>use<span class="w"> </span>the<span class="w"> </span><span class="s2">&quot;CodeChecker store&quot;</span><span class="w"> </span>command.
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span>See<span class="w"> </span>--help<span class="w"> </span>and<span class="w"> </span>the<span class="w"> </span>user<span class="w"> </span>guide<span class="w"> </span><span class="k">for</span><span class="w"> </span>further<span class="w"> </span>options<span class="w"> </span>about<span class="w"> </span>parsing<span class="w"> </span>and<span class="w"> </span>storing<span class="w"> </span>the<span class="w"> </span>reports.
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span>----<span class="o">=================</span>----
<span class="o">[</span>INFO<span class="w"> </span><span class="m">2019</span>-07-16<span class="w"> </span><span class="m">17</span>:21<span class="o">]</span><span class="w"> </span>-<span class="w"> </span>Analysis<span class="w"> </span>length:<span class="w"> </span><span class="m">0</span>.659618854523<span class="w"> </span>sec.
$<span class="w"> </span>ls
compile_commands.json<span class="w">  </span>foo.cpp<span class="w">  </span>foo.cpp.ast<span class="w">  </span>main.cpp<span class="w">  </span>reports
$<span class="w"> </span>tree<span class="w"> </span>reports
reports
├──<span class="w"> </span>compile_cmd.json
├──<span class="w"> </span>compiler_info.json
├──<span class="w"> </span>foo.cpp_53f6fbf7ab7ec9931301524b551959e2.plist
├──<span class="w"> </span>main.cpp_23db3d8df52ff0812e6e5a03071c8337.plist
├──<span class="w"> </span>metadata.json
└──<span class="w"> </span>unique_compile_commands.json

<span class="m">0</span><span class="w"> </span>directories,<span class="w"> </span><span class="m">6</span><span class="w"> </span>files
$
</pre></div>
</div>
<p>The <cite>plist</cite> files contain the results of the analysis, which may be viewed with the regular analysis tools.
E.g. one may use <cite>CodeChecker parse</cite> to view the results in command line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>CodeChecker<span class="w"> </span>parse<span class="w"> </span>reports
<span class="o">[</span>HIGH<span class="o">]</span><span class="w"> </span>/home/egbomrt/ctu_mini_raw_project/main.cpp:5:12:<span class="w"> </span>Division<span class="w"> </span>by<span class="w"> </span>zero<span class="w"> </span><span class="o">[</span>core.DivideZero<span class="o">]</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="m">3</span><span class="w"> </span>/<span class="w"> </span>foo<span class="o">()</span><span class="p">;</span>
<span class="w">           </span>^

Found<span class="w"> </span><span class="m">1</span><span class="w"> </span>defect<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>main.cpp


----<span class="o">====</span><span class="w"> </span><span class="nv">Summary</span><span class="w"> </span><span class="o">====</span>----
-----------------------
Filename<span class="w"> </span><span class="p">|</span><span class="w"> </span>Report<span class="w"> </span>count
-----------------------
main.cpp<span class="w"> </span><span class="p">|</span><span class="w">            </span><span class="m">1</span>
-----------------------
-----------------------
Severity<span class="w"> </span><span class="p">|</span><span class="w"> </span>Report<span class="w"> </span>count
-----------------------
HIGH<span class="w">     </span><span class="p">|</span><span class="w">            </span><span class="m">1</span>
-----------------------
----<span class="o">=================</span>----
Total<span class="w"> </span>number<span class="w"> </span>of<span class="w"> </span>reports:<span class="w"> </span><span class="m">1</span>
----<span class="o">=================</span>----
</pre></div>
</div>
<p>Or we can use <cite>CodeChecker parse -e html</cite> to export the results into HTML format:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>CodeChecker<span class="w"> </span>parse<span class="w"> </span>-e<span class="w"> </span>html<span class="w"> </span>-o<span class="w"> </span>html_out<span class="w"> </span>reports
$<span class="w"> </span>firefox<span class="w"> </span>html_out/index.html
</pre></div>
</div>
</section>
<section id="automated-ctu-analysis-with-scan-build-py-don-t-do-it">
<h2><a class="toc-backref" href="#id4" role="doc-backlink"><span class="section-number">2.1.3. </span>Automated CTU Analysis with scan-build-py (don't do it)</a><a class="headerlink" href="#automated-ctu-analysis-with-scan-build-py-don-t-do-it" title="連結到這個標頭">¶</a></h2>
<p>We actively develop CTU with CodeChecker as a &quot;runner&quot; script, <cite>scan-build-py</cite> is not actively developed for CTU.
<cite>scan-build-py</cite> has various errors and issues, expect it to work with the very basic projects only.</p>
<p>Example usage of scan-build-py:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>/your/path/to/llvm-project/clang/tools/scan-build-py/bin/analyze-build<span class="w"> </span>--ctu
analyze-build:<span class="w"> </span>Run<span class="w"> </span><span class="s1">&#39;scan-view /tmp/scan-build-2019-07-17-17-53-33-810365-7fqgWk&#39;</span><span class="w"> </span>to<span class="w"> </span>examine<span class="w"> </span>bug<span class="w"> </span>reports.
$<span class="w"> </span>/your/path/to/llvm-project/clang/tools/scan-view/bin/scan-view<span class="w"> </span>/tmp/scan-build-2019-07-17-17-53-33-810365-7fqgWk
Starting<span class="w"> </span>scan-view<span class="w"> </span>at:<span class="w"> </span>http://127.0.0.1:8181
<span class="w">  </span>Use<span class="w"> </span>Ctrl-C<span class="w"> </span>to<span class="w"> </span>exit.
<span class="o">[</span><span class="m">6336</span>:6431:0717/175357.633914:ERROR:browser_process_sub_thread.cc<span class="o">(</span><span class="m">209</span><span class="o">)]</span><span class="w"> </span>Waited<span class="w"> </span><span class="m">5</span><span class="w"> </span>ms<span class="w"> </span><span class="k">for</span><span class="w"> </span>network<span class="w"> </span>service
Opening<span class="w"> </span><span class="k">in</span><span class="w"> </span>existing<span class="w"> </span>browser<span class="w"> </span>session.
^C
$
</pre></div>
</div>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="Bottom">
      
        <p>
        «&#160;&#160;<a href="../user-docs.html"><span class="section-number">2. </span>User Docs</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../index.html">內容</a>
        &#160;&#160;::&#160;&#160;
        <a href="../developer-docs.html"><span class="section-number">3. </span>Developer Docs</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; 版權所有 2007-2025, The Clang Team.
      使用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3 建立。
    </div>
  </body>
</html>